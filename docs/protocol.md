# parsing a protocol file from xyz

## Overview of the format '\*.p'

The .p files are a definition of timing for when to measure, and what to label the data as for later calcualtion of paramters. The protocols are a simple text file with the '.p' suffix. Lines that start with a semicolon are commented out and ignored by the Fluorcam protocol parser.

The protocol file is divided into a few main sections. The first section is a header, where common parameters are defined. The second section is a definition of functions, or "Actions", that are later utilized in the third section. The third section is a list of commands that are executed in order. This includes turning on and off the actinic lights, taking measurements, and assigning labels to the image data. Commands follow a particular syntax, combining a time and an Action. This syntax is described in the command section below.

## Definitions of parameters

The first section of a protocol file is the definition of parameters. Parameters are defined using the following syntax:

```{protocol}
TS=20ms
;protocol body - generated by wizard
;version ZB February 11, 2010
include default.inc  ;Includes standard options, do not remove it !
include light.inc    ;Includes standard options, do not remove it !
Shutter=3
Sensitivity=52
Act1=100
Super=100
```

Super is the light intensity during the saturation pulse, which utilizes both red and blue actinic banks (Act1 and Act2, respectively). Full intensity is 100, and equates to around 400 uE.

THe include statements are required by the instrument, and should be included in any new protocol file.

TS=20ms defines the time step for the protocol. This is the smallest time increment that the instrument can use. The instrument will accept any number here, but using a different number may lead to undefined behavior.

Definitions can also be called in the body of the protocol file, and behave exactly the same way. The header definitions are placed at the top as a matter of convenience and readability, rather than necessity.

## Action Definitions

The second section of a protocol file is the definition of actions. Actions are defined using the following syntax:

```{protocol}
Action SATPULSE begin
  <-mfmsub_length>=>mfmsub ;before pulse
  <0s>=>SatPulse(800ms)
  <TS,TS + 2 * mfmsub_length .. 800ms/2 - mfmsub_length>=>mfmsub
  <800ms/2,800ms/2 + mfmsub_length .. 800ms>=>mfmsub
  <800ms + mfmsub_length>=>mfmsub
end
;
```

Note that each Action will being with the word Action, following by the name of the action. It is convention to write user-defined Action names in all caps. Fluorcam provided Actions are in lower case, such as act1() and The action will then be followed by the word begin followed by a new line. The action will end with the word end on a new line.

In between begin and end, there is a list of commands and definitions. Each command is on a new line. These commands are executed in order, and are written in the format of `<time>=>command.` The time is the time at which the command is executed. The command is the action to be executed. Many of the normal commands are just calls to mfmsub, which is a macro meaning "measure, flash, measure, then substract".

## Time Syntax

There are two main types of time syntax. The first is a simple time, given in seconds or milliseconds. It executes the given Action at a time in reference to either the beginning of the Action in which it is written, or in reference to the beginning of protocol execution by the program.

The second time syntax is<800ms/2,800ms/2 + mfmsub_length .. 800ms>=>mfmsub<800ms/2,800ms/2 + mfmsub_length .. 800ms>=>mfmsub
The time portion of these Actions does not follow the normal format. It is not a single timepoint. Instead, it defines a sequence of timepoints. The sequence definitions is written as `<start, step .. end>`. This defines a sequence of timepoints from start to end, with a step size of step. All time information is in reference to the moment the Action is called, not the outside time. For example, if the Action is called at 10s, and the sequence is `<0s, 1s .. 10s>`, then the sequence will be 10s, 11s, 12s, 13s, 14s, 15s, 16s, 17s, 18s, 19s, 20s.

The following is an example of a sequence definition:

```{protocol}
    <800ms/2,800ms/2 + mfmsub_length .. 800ms>=>mfmsub
```

In this example, the sequence starts at 800ms/2, and ends at 800ms. The step size is 800ms/2 + mfmsub_length. This means that the mfmsub Action will be executed at the following timepoints: 800ms/2, 800ms/2 + 800ms/2 + mfmsub_length, 800ms/2 + 2 \* (800ms/2 + mfmsub_length), and so on until the end of the sequence is reached.

## Action calls

Calling an Action is done by providing the Action name, with optional parentheses and arguments to provide to the action. If the Action name was defined with arguments, it must be called with arugments provided. `SATPULSE` is acceptable usage, but `SATPULSE(100ms)` is not, as it was not defined with arguments.

## Command Syntax

Commands are written in the format of `<time>=>Action`. Time is a number followed by a unit of time, with no space in between. The units used are `ms` and `s`, referring to milliseconds and seconds. The time field can contain mathematical operations, such as `<PulseStart + PulseDuration - 3*mfmsub_length>`. This example would execute the Action three \* mfmsub_lengths before the end of the pulse. You must be careful not to allow Action executions to overlap inadvertently. The instrument will not allow this, and will throw an error if it occurs.

## Pre-defined Actions

A few of the common pre-defined Actions are listed below. You will see these in existing protocols, and they are useful to know.

```{protocol}
<time>=>mfmsub  ## a call to perform a measurement at the <time> specified
<time>=>act1(PulseDuration) ## a call to turn on the actinic light 1 (red) for <PulseDuration> at <time>
<time>=>act2(PulseDuration) ## a call to turn on the actinic light 2 (blue) for <PulseDuration> at <time>
<time>=>checkPoint,"<label>" ## a call to label the data at <time> with <label>, ex "startFm_D3".
```

## Special Characters:

When parsing the protocol, each line should be split into tokens. The tokens are not seperated by spaces, and are divided by certain characters depending on the type of command or action they belong to. The following is a partial list of the token dividers that are used in the protocol file.

- `;` - comment character. Everything after this character is ignored.
- `<` - begin time definition
- `>` - end time definition. If the `>` id preceded by an equal sign, then it is not a time definition, but a command definition.
- `,` - seperates begin and step arguments in a time sequence definition.
- `..` - seperates step and end arguments in a time sequence definition.
- `=>` - command definition. The token to the left of the `=>` is the time, and the token to the right is the command.
- `+` - addition operator. Used in time definitions.
- `*` - multiplication operator. Used in variables and time definitions.
- `s` - seconds unit. Used in time definitions. Always the rightmost character of a time unit.
- `ms` - milliseconds unit. Used in time definitions. Always the rightmost character of a time unit.
- `##` - comment character. Strip all lines of this character and everything after it.
- `mfmsublength` - a variable that is defined elsewhere in the fluorcam code. We do not know exactly what it is, but it is used in the time definitions of the protocol files.
- `( )` - parentheses. Used to define arguments to an action. -`checkPoint,"x"` - checkPoint label declaration. Used to define a string argument to the checkPoint action. Checkpoint is a special case of action. It is not called with parentheis, but instead with a comma followed by quotation marks. The string inside the quotation marks is the label that is assigned to the data at that timepoint.

````{protocol}
discard lines starting with ;
< denotes a line that has a command pair
Action denotes the beginning of a new action
end denotes the end of an action
=> denotes the separation between time and command
, denotes the separation between elements of a squence

### Definitions

### Time Definition Syntax

- `var=100.0`
- `var=100`
- `var=100ms`
- `var=100s`
- `var=100.2s`
- `var=var2 + 11s`
- `var=var2 + var3`
- `<...>` encapsulates a time point. It can be a single time point, or an arithmetic expression including variables and numbers
- `<-x>` is a time point relative to the beginning of the action, can be negative (x time before current action would be called)

### commands

- `<time>=>text`
- `<time>=>text(time)`

### section labels for readability

There are section labels for dividing the protocol into broad categories, and for readability. These are not required, but are useful for organizing the protocol. The section labels are:

```{protocol}
;--------------------------------------------------------------------------------------
;******* Dark Relaxation Measurement **************************************************
;--------------------------------------------------------------------------------------
````

Three lines, first line is a semicolor followed by x dashes, second line is the section label placed inside of a left and right buffer of asterisks, with one space on either side of the label. The third line is the same as the first line.

Common section labels are:

- Fo Measurement
- Fm Measurement
- Dark Relaxation Measurement
- Light Adaptation Measurement

### label of time points or pulses

Within a section, individual pulses can be labels with a time point label just before the actions. This is usually just a line with a semicolon and the label. For example `;dark pulse D3`.
